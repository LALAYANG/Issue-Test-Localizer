{"model_name_or_path": "agentless", "instance_id": "django__django-16263", "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex ab02d72..0652b76 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -550,6 +550,17 @@ class Query(BaseExpression):\n         Perform a COUNT() query using the current filter constraints.\n         \"\"\"\n         obj = self.clone()\n+        # Strip unused annotations for count query\n+        if obj.annotation_select:\n+            annotations_to_keep = {\n+                alias for alias, annotation in obj.annotations.items()\n+                if obj.where.contains_aggregate(annotation)\n+                or obj.group_by is True\n+                or any(\n+                    alias in expr.refs for expr in obj.annotations.values()\n+                )\n+            }\n+            obj.set_annotation_mask(annotations_to_keep)\n         obj.add_annotation(Count(\"*\"), alias=\"__count\", is_summary=True)\n         return obj.get_aggregation(using, [\"__count\"])[\"__count\"]\n \n"}
